<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OPS Storage Debug</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 1rem;
      background: #05050a;
      color: #f5f5ff;
    }
    h1 { margin-bottom: 0.25rem; }
    small { color: #b3b3d9; }
    label { font-weight: 600; display: block; margin-top: 0.75rem; }
    input {
      width: 100%;
      max-width: 480px;
      padding: 0.35rem 0.45rem;
      margin-top: 0.25rem;
      border-radius: 6px;
      border: 1px solid #44446a;
      background: #090912;
      color: inherit;
    }
    button {
      margin-top: 0.75rem;
      padding: 0.4rem 0.9rem;
      border-radius: 6px;
      border: 1px solid #66f2c9;
      background: #101722;
      color: #66f2c9;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status {
      margin-top: 0.75rem;
      font-weight: 700;
    }
    .ok { color: #66f2c9; }
    .warn { color: #ffd166; }
    .bad { color: #ff6b6b; }
    .section {
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid #2a2a45;
    }
    dl { margin: 0.25rem 0; }
    dt {
      font-weight: 600;
      margin-top: 0.4rem;
    }
    dd {
      margin: 0 0 0.15rem 0.75rem;
      font-size: 0.9rem;
    }
    pre {
      background: #090912;
      border-radius: 6px;
      padding: 0.5rem;
      max-height: 280px;
      overflow: auto;
      font-size: 0.8rem;
    }
    code { font-family: "JetBrains Mono", Consolas, monospace; }
  </style>
</head>
<body>
  <h1>OPS Storage Debug</h1>
  <small>Calls <code>/debug/storage</code> on your Worker and tells you where it is broken.</small>

  <label for="baseUrl">
    Worker base URL
    <small>(no trailing slash)</small>
  </label>
  <input id="baseUrl" type="url" placeholder="https://withered-mouse-9aee.grabem-holdem-nuts-right.workers.dev">

  <button id="runBtn" type="button">Run storage check</button>

  <div id="summary" class="status"></div>

  <div id="sections"></div>

  <div class="section">
    <strong>Raw JSON</strong>
    <pre id="raw"></pre>
  </div>

  <script>
    const baseInput = document.getElementById('baseUrl');
    const runBtn = document.getElementById('runBtn');
    const summaryEl = document.getElementById('summary');
    const sectionsEl = document.getElementById('sections');
    const rawEl = document.getElementById('raw');

    runBtn.addEventListener('click', runCheck);

    // Optional: default to current origin
    if (!baseInput.value) {
      baseInput.value = location.origin.replace(/\/$/, '');
    }

    function classifySummary(code) {
      switch (code) {
        case 'S-OK': return { cls: 'ok', text: 'SYNC — KV, R2 and D1 all OK' };
        case 'S-PARTIAL': return { cls: 'warn', text: 'PARTIAL — some bindings failing' };
        case 'S-FAIL': return { cls: 'bad', text: 'FAIL — none of KV/R2/D1 working' };
        default: return { cls: 'warn', text: 'Unknown summary' };
      }
    }

    function formatAreaTitle(area, data) {
      const code = data.code || 'N/A';
      const ok = data.ok ? 'OK' : 'FAIL';
      return `${area} (${ok}) — ${code}`;
    }

    function nextStepFor(area, code) {
      // Very small decision tree per code
      if (area === 'KV') {
        if (code === 'K-01') return 'Check wrangler.toml -> [[kv_namespaces]] binding = "OPS_TRANSCRIPTS_KV" and make sure the Namespace ID exists in Cloudflare.';
        if (code === 'K-02') return 'KV reachable but value mismatch. Try deleting the namespace and re-creating it, then re-deploy.';
      }
      if (area === 'R2') {
        if (code === 'R-01') return 'Check wrangler.toml -> [[r2_buckets]] binding = "OPS_ARTIFACTS_R2" and make sure the bucket "ops-artifacts" exists in Cloudflare.';
        if (code === 'R-02') return 'R2 reachable but object mismatch. Confirm bucket name and that this Worker has R2 access in Cloudflare dashboard.';
      }
      if (area === 'D1') {
        if (code === 'D-01') return 'Check wrangler.toml -> [[d1_databases]] binding = "OPS_TRAINING_DB" and ensure the D1 database exists.';
        if (code === 'D-02') return 'D1 query failed. Check that the database is created and not deleted. You can also try a basic SELECT in the D1 UI.';
        if (code === 'D-03') return 'D1 returned an unexpected row. Check the SQL ("SELECT 1 AS ok") and DB status in the D1 dashboard.';
      }
      return 'Review wrangler.toml bindings and Cloudflare dashboard for this area.';
    }

    async function runCheck() {
      summaryEl.textContent = '';
      sectionsEl.innerHTML = '';
      rawEl.textContent = '';
      runBtn.disabled = true;

      let url = baseInput.value.trim();
      if (!url) {
        alert('Please enter the Worker base URL.');
        runBtn.disabled = false;
        return;
      }
      url = url.replace(/\/$/, '') + '/debug/storage';

      try {
        const res = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Summary
        const summary = classifySummary(data.summaryCode);
        summaryEl.className = `status ${summary.cls}`;
        summaryEl.textContent = `${summary.text} (${data.summaryCode || 'N/A'})`;

        // Detail per area
        const groups = [
          ['KV', data.kv],
          ['R2', data.r2],
          ['D1', data.d1]
        ];

        let html = '';
        for (const [area, obj] of groups) {
          if (!obj) continue;
          const title = formatAreaTitle(area, obj);
          const binding = obj.binding ? obj.binding : 'N/A';
          const error = obj.error || (obj.ok ? 'No error' : 'Unknown error');
          const step = nextStepFor(area, obj.code);

          html += `
            <div class="section">
              <h2>${title}</h2>
              <dl>
                <dt>Binding</dt>
                <dd><code>${binding}</code></dd>

                <dt>Code</dt>
                <dd><code>${obj.code || 'N/A'}</code></dd>

                <dt>OK?</dt>
                <dd>${obj.ok ? 'true' : 'false'}</dd>

                <dt>Error / message</dt>
                <dd>${error}</dd>

                <dt>Suggested next step</dt>
                <dd>${step}</dd>
              </dl>
            </div>
          `;
        }

        // Diagnostics list, if any
        if (Array.isArray(data.diagnostics) && data.diagnostics.length) {
          html += `<div class="section"><h2>Diagnostics list</h2><ul>`;
          for (const diag of data.diagnostics) {
            html += `<li><code>${diag.code}</code> [${diag.area}]: ${diag.message}</li>`;
          }
          html += `</ul></div>`;
        }

        sectionsEl.innerHTML = html;

        // Raw JSON view
        rawEl.textContent = JSON.stringify(data, null, 2);

      } catch (err) {
        summaryEl.className = 'status bad';
        summaryEl.textContent = `Network / CORS error: ${err.message || err}`;
        sectionsEl.innerHTML = '';
        rawEl.textContent = '';
      } finally {
        runBtn.disabled = false;
      }
    }
  </script>
</body>
</html>

