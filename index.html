<!-- index.html â€” GitHub Pages UI (auth â†’ signed chat; hidden STT panel wired) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Chattia</title>
<meta name="integrity-token" content="https://chattiavato-a11y.github.io">
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  integrity="sha512-RXf+QSDCUqpphKAa+WAc3XQ8fE5H1aO/8e2wY+8Q1n8yVwDh1RZTf1TDN8E+u1n7eU5KyY7X2Qo+hqeZZn+UAQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
:root{ --clr-primary:#00c4ff; --clr-accent:#ff3bdb; --clr-bg:#fff; --tx:#222; --bg2:#1b0e2d; }
body{ margin:0; font-family:system-ui,Segoe UI,Arial; background:var(--clr-bg); color:var(--tx); }
#chatbot-container{position:fixed;width:300px;height:540px;background:#251541;border:2px solid var(--clr-accent);
  border-radius:18px;box-shadow:0 8px 32px #0006;display:flex;flex-direction:column;overflow:hidden;
  right:24px;bottom:24px}
#chatbot-header{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;
  background:linear-gradient(135deg,var(--clr-primary),var(--clr-accent));color:#fff;font-weight:600}
#chat-log{flex:1;overflow:auto;padding:1rem;background:var(--bg2);color:#eee;font-size:.94rem}
.chat-msg{margin:.5rem 0;max-width:90%}
.user{margin-left:auto;background:var(--clr-primary);color:#000;padding:.5rem .7rem;border-radius:14px 14px 0 14px}
.bot{margin-right:auto;background:#321b53;color:#fff;padding:.5rem .7rem;border-radius:14px 14px 14px 0}
#chatbot-form-container{background:#220f3a;border-top:1px solid var(--clr-accent);padding:.55rem .7rem}
#chatbot-input-row{display:flex;gap:.6rem}
#chatbot-input{flex:1;background:transparent;border:none;color:#fff;font-size:.95rem;padding:.55rem .6rem}
#chatbot-send{display:flex;align-items:center;justify-content:center;gap:6px;background:var(--clr-accent);border:none;color:#fff;
  font-weight:600;padding:.5rem .9rem;border-radius:8px;cursor:pointer}
.turnstile-slot{height:0;overflow:hidden} /* keep hidden; required token still generated */
#stt-controls{display:none} /* hide STT panel; still wired for background use */
</style>
</head>
<body>

<div id="chatbot-container" role="dialog" aria-modal="true">
  <div id="chatbot-header"><span>Chattia</span><span id="themeCtrl" class="ctrl">Dark</span></div>
  <div id="chat-log" aria-live="polite"></div>
  <div id="chatbot-form-container">
    <form id="chatbot-input-row" autocomplete="off">
      <div id="turnstile-slot" class="turnstile-slot" aria-hidden="true"></div>
      <input id="turnstile-token" type="hidden" name="cf-turnstile-response" value="" data-require="true">
      <label class="visually-hidden" for="chatbot-company">Company</label>
      <input id="chatbot-company" type="text" name="company" autocomplete="off" aria-hidden="true" tabindex="-1" style="position:absolute;left:-9999px">
      <input id="chatbot-input" type="text" placeholder="Type your messageâ€¦ [Enter]" maxlength="256">
      <button id="chatbot-send" type="submit" aria-label="Send"><i class="fa fa-arrow-right"></i></button>
    </form>
  </div>
</div>

<!-- Hidden STT wiring (file + mic). Toggle display via CSS if you want to show it. -->
<div id="stt-controls">
  <input id="stt-file" type="file" accept="audio/*">
  <select id="stt-lang"><option value="en" selected>en</option><option value="es">es</option></select>
  <select id="stt-prefer"><option value="">auto</option><option>tiny</option><option>base</option><option>turbo</option><option>vendor</option></select>
  <button id="stt-send" type="button">Transcribe file</button>
  <button id="mic-btn" type="button">ðŸŽ™ Start</button>
  <pre id="stt-out"></pre>
</div>

<script>
/* ------------------- CONFIG (match Worker) ------------------- */
const INTEGRITY_VALUE   = (document.querySelector('meta[name="integrity-token"]')?.content||'').trim() || 'https://chattiavato-a11y.github.io';
const INTEGRITY_GATEWAY = 'https://withered-mouse-9aee.grabem-holdem-nuts-right.workers.dev';
const INTEGRITY_PROTOCOLS = 'CORS,CSP,OPS-CySec-Core,CISA,NIST,PCI-DSS,SHA-384,SHA-512';

const API_BASE = 'https://withered-mouse-9aee.grabem-holdem-nuts-right.workers.dev';
const CHAT_PATH = '/api/chat';
const STT_PATH  = '/api/stt';
const AUTH_URL  = `${API_BASE}/auth/issue`;

const TURNSTILE_SITE_KEY = '0x4AAAAAACBDyXYbdQg180H4';

const sharedIntegrityHeaders = Object.freeze({
  'X-Integrity': INTEGRITY_VALUE,
  'X-Integrity-Gateway': INTEGRITY_GATEWAY,
  'X-Integrity-Protocols': INTEGRITY_PROTOCOLS
});

/* ------------------- UI refs ------------------- */
const logEl  = document.querySelector('#chat-log');
const form   = document.querySelector('#chatbot-input-row');
const input  = document.querySelector('#chatbot-input');
const send   = document.querySelector('#chatbot-send');
const honeyp = document.querySelector('#chatbot-company');
const tSlot  = document.querySelector('#turnstile-slot');
const tTok   = document.querySelector('#turnstile-token');

const state = { conversation:[], isSending:false };
const session = { terminated:false };

function addMsg(t,cls){ const d=document.createElement('div'); d.className='chat-msg '+cls; d.textContent=t; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; return d; }
function sanitize(s=''){ return s.replace(/[<>]/g,'').replace(/\s+/g,' ').trim(); }
function violatesPolicy(text){
  const lower = text.toLowerCase();
  const bad = [/^.*(<[^>]+>|script|malicious|attack|prompt|ignore|hack|drop\s+table).*$/i].some(rx=>rx.test(lower));
  const onTopic = ["website","site","chattia","product","service","support","order","account","pricing","contact","help"].some(w=>lower.includes(w));
  return bad || !onTopic;
}

/* ------------------- Turnstile (hidden) ------------------- */
let turnstileWidgetId = null;
function loadTurnstile(){
  if (!tSlot || document.getElementById('cf-turnstile')) return;
  const s = document.createElement('script');
  s.id='cf-turnstile'; s.src='https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit'; s.async=true; s.defer=true;
  s.onload = () => {
    if (!window.turnstile) return;
    const id = window.turnstile.render(tSlot, {
      sitekey: TURNSTILE_SITE_KEY,
      theme: 'auto',
      callback(token){ tTok.value = token; tTok.dataset.require='false'; },
      'error-callback':()=>{ tTok.value=''; tTok.dataset.require='true'; },
      'expired-callback':()=>{ tTok.value=''; tTok.dataset.require='true'; }
    });
    turnstileWidgetId = id;
  };
  document.head.appendChild(s);
}
loadTurnstile();

/* ------------------- Integrity signing (browser) ------------------- */
function hexNonce32(){ const u8=crypto.getRandomValues(new Uint8Array(16)); return [...u8].map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function sha256Hex(input){
  const enc = typeof input==='string' ? new TextEncoder().encode(input) : (input instanceof Uint8Array ? input : new Uint8Array(input));
  const d = await crypto.subtle.digest('SHA-256', enc);
  return [...new Uint8Array(d)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function mintSignature(path, method, bodySha){
  const ts = Math.floor(Date.now()/1000);
  const nonce = hexNonce32();
  const payload = { ts, nonce, method, path, body_sha256: bodySha };
  const r = await fetch(AUTH_URL, { method:'POST', headers:{...sharedIntegrityHeaders,'Content-Type':'application/json'}, body:JSON.stringify(payload) });
  if (!r.ok) throw new Error('auth_issue_failed');
  const j = await r.json();
  if (!j?.signature) throw new Error('signature_missing');
  return { signature:j.signature, ts:String(ts), nonce };
}
async function signedPost(path, json){
  const body = JSON.stringify(json);
  const bodySha = await sha256Hex(body);
  const {signature, ts, nonce} = await mintSignature(path, 'POST', bodySha);
  return fetch(`${API_BASE}${path}`, {
    method:'POST',
    headers:{ ...sharedIntegrityHeaders, 'Content-Type':'application/json','X-Request-Signature':signature,'X-Request-Timestamp':ts,'X-Request-Nonce':nonce },
    body
  });
}
async function signedFormPost(path, form){
  const probe = new Request('https://example.invalid',{method:'POST',body:form});
  const buf = await probe.arrayBuffer();
  const ct  = probe.headers.get('content-type') || 'application/octet-stream';
  const bodySha = await sha256Hex(buf);
  const {signature, ts, nonce} = await mintSignature(path, 'POST', bodySha);
  return fetch(`${API_BASE}${path}`, {
    method:'POST',
    headers:{ ...sharedIntegrityHeaders, 'Content-Type':ct, 'X-Request-Signature':signature,'X-Request-Timestamp':ts,'X-Request-Nonce':nonce },
    body: buf
  });
}

/* ------------------- Chat flow ------------------- */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (session.terminated) return;
  if (honeyp?.value.trim()) return; // honeypot
  if (tTok.dataset.require==='true' || !tTok.value.trim()) return;

  const msg = sanitize(input.value);
  if (!msg) return;
  addMsg(msg,'user');
  input.value='';

  if (violatesPolicy(msg)) { addMsg("Apologies, but I cannot execute that request, do you have any questions about our website?",'bot'); return; }

  state.conversation.push({role:'user',content:msg});
  const typing = addMsg('â€¦','bot');

  try{
    const r = await signedPost(CHAT_PATH, { messages: state.conversation, metadata:{ channel:'chattia-web', locale:(document.documentElement.lang||'en') }, 'cf-turnstile-response': tTok.value });
    const d = await r.json();
    const reply = (d.reply||'No reply.').trim();
    typing.textContent = reply;
    state.conversation.push({role:'assistant',content:reply});
  }catch{
    typing.textContent = 'Error: Canâ€™t reach Chattia.';
  } finally {
    // Force a fresh token next turn
    tTok.value=''; tTok.dataset.require='true';
    if (window.turnstile && turnstileWidgetId!==null) try{ window.turnstile.reset(turnstileWidgetId); }catch{}
  }
});

/* ------------------- Hidden STT wiring ------------------- */
const $ = s=>document.querySelector(s);
const chatInput = $('#chatbot-input');

$('#stt-send')?.addEventListener('click', async ()=>{
  const f = $('#stt-file')?.files?.[0]; if (!f) return;
  if (tTok.dataset.require==='true' || !tTok.value.trim()) return;
  const form = new FormData(); form.append('audio', f); form.append('lang',$('#stt-lang').value||'en'); form.append('prefer',$('#stt-prefer').value||'');
  form.set('cf-turnstile-response', tTok.value);
  const r = await signedFormPost(STT_PATH, form); const d = await r.json();
  if (r.ok && d?.text && chatInput) chatInput.value = d.text;
  tTok.value=''; tTok.dataset.require='true';
  if (window.turnstile && turnstileWidgetId!==null) try{ window.turnstile.reset(turnstileWidgetId); }catch{}
});

let rec, media, chunks=[], recording=false;
$('#mic-btn')?.addEventListener('click', async ()=>{
  if (!recording){
    if (tTok.dataset.require==='true' || !tTok.value.trim()) return;
    try{
      chunks=[]; media=await navigator.mediaDevices.getUserMedia({audio:true});
      rec=new MediaRecorder(media,{mimeType:'audio/webm'}); rec.ondataavailable=e=>{ if(e.data&&e.data.size) chunks.push(e.data); }; rec.start(); recording=true;
    }catch{ return; }
    return;
  }
  rec.stop(); media.getTracks().forEach(t=>t.stop()); recording=false;
  const blob = new Blob(chunks,{type:'audio/webm'}); if (blob.size>8_000_000) return;
  const form = new FormData(); form.append('audio', blob,'clip.webm'); form.append('lang',$('#stt-lang').value||'en'); form.append('prefer',$('#stt-prefer').value||''); form.set('cf-turnstile-response', tTok.value);
  const r = await signedFormPost(STT_PATH, form); const d = await r.json();
  if (r.ok && d?.text && chatInput) chatInput.value = d.text;
  tTok.value=''; tTok.dataset.require='true';
  if (window.turnstile && turnstileWidgetId!==null) try{ window.turnstile.reset(turnstileWidgetId); }catch{}
});
</script>
</body>
</html>
